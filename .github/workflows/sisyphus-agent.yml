name: Sisyphus Agent

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Custom prompt"
        required: false
  issue_comment:
    types: [created]

jobs:
  agent:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      (contains(github.event.comment.body, '@sisyphus-agent') &&
       github.event.comment.user.login != 'sisyphus-agent' &&
       contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.comment.author_association))

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "${{ vars.GIT_USER_NAME }}"
          git config user.email "${{ vars.GIT_USER_EMAIL }}"

      - name: Authenticate gh CLI
        run: |
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          gh auth status

      - name: Ensure tmux is available
        if: runner.os == 'Linux'
        run: |
          set -euo pipefail
          if ! command -v tmux >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y --no-install-recommends tmux
          fi
          tmux -V

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/bun.lock') }}

      - name: Install project dependencies
        run: bun install

      - name: Install Playwright browsers
        run: |
          if [ "${{ steps.playwright-cache.outputs.cache-hit }}" != "true" ]; then
            bunx playwright install --with-deps chromium
          else
            bunx playwright install-deps chromium
          fi

      - name: Setup Convex environment
        env:
          CONVEX_AGENT_MODE: anonymous
        run: |
          # Start Convex dev server in background (non-interactive mode)
          bunx convex dev &
          CONVEX_PID=$!
          
          # Wait for Convex to be ready (check for the local backend)
          echo "Waiting for Convex dev server to start..."
          for i in {1..60}; do
            if curl -s http://127.0.0.1:3210 > /dev/null 2>&1; then
              echo "Convex dev server is ready!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Timeout waiting for Convex dev server"
              kill $CONVEX_PID 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done
          
          # Set the BETTER_AUTH_SECRET in Convex local environment
          bunx convex env set BETTER_AUTH_SECRET "ci-secret-key-for-testing-min-32-chars-long"
          
          # Stop the background Convex dev server (env is persisted)
          kill $CONVEX_PID 2>/dev/null || true
          
          # Small delay to ensure clean shutdown
          sleep 2
          
          echo "Convex environment configured successfully"

      - name: Setup OpenCode with oh-my-opencode plugin
        env:
          OPENCODE_AUTH_JSON: ${{ secrets.OPENCODE_AUTH_JSON }}
        run: |
          set -euo pipefail
          export PATH="$HOME/.opencode/bin:$PATH"

          if ! command -v opencode &>/dev/null; then
            echo "Installing OpenCode..."
            curl -fsSL https://opencode.ai/install -o /tmp/opencode-install.sh
            if file /tmp/opencode-install.sh | grep -q "shell script\|text"; then
              if ! bash /tmp/opencode-install.sh 2>&1; then
                echo "Default installer failed, trying with pinned version..."
                bash /tmp/opencode-install.sh --version 1.0.204
              fi
            else
              echo "Download corrupted, trying direct install with pinned version..."
              bash <(curl -fsSL https://opencode.ai/install) --version 1.0.204
            fi
          fi
          opencode --version

          mkdir -p ~/.config/opencode
          mkdir -p ~/.local/share/opencode

          jq -n '{
            "$schema": "https://opencode.ai/config.json",
            "plugin": ["oh-my-opencode"]
          }' > ~/.config/opencode/opencode.json

          jq -n '{
            "$schema": "https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/master/assets/oh-my-opencode.schema.json",
            "agents": {
              "Sisyphus": { "model": "github-copilot/claude-opus-4.5" },
              "oracle": { "model": "github-copilot/gpt-5.2" },
              "librarian": { "model": "github-copilot/claude-sonnet-4.5" },
              "explore": { "model": "github-copilot/claude-sonnet-4.5" },
              "frontend-ui-ux-engineer": { "model": "github-copilot/claude-sonnet-4.5" },
              "document-writer": { "model": "github-copilot/claude-sonnet-4.5" },
              "multimodal-looker": { "model": "github-copilot/claude-sonnet-4.5" }
            }
          }' > ~/.config/opencode/oh-my-opencode.json

          OMO_JSON=~/.config/opencode/oh-my-opencode.json
          cat > /tmp/prompt_append.txt <<'PROMPT_EOF'

          ## GitHub Actions Environment

          You are running in GitHub Actions.

          ### CRITICAL: GitHub Comments = Your ONLY Output

          User CANNOT see console. Post everything via `gh issue comment` or `gh pr comment`.

          ### Comment Formatting (CRITICAL)

          ALWAYS use heredoc syntax for comments containing code references, backticks, or multiline content:

          ```bash
          gh issue comment <number> --body "$(cat <<'EOF'
          Your comment with backticks and code references preserved here.
          Multiple lines work perfectly.
          EOF
          )"
          ```

          NEVER use direct quotes with backticks (shell will interpret them as command substitution).

          ### GitHub Markdown Rules (MUST FOLLOW)

          Code blocks MUST have EXACTLY 3 backticks and language identifier.
          Every opening ``` MUST have a closing ``` on its own line.
          NO trailing backticks or spaces after closing ```.
          For inline code, use SINGLE backticks.

          ### Rules
          - EVERY response = GitHub comment (use heredoc for proper escaping)
          - Code changes = PR (never push main/master)
          - Setup: bun install first
          - Acknowledge immediately, report when done

          ### Testing Commands Available
          - Unit + Component tests: bun test
          - Convex backend tests: bun run test:convex
          - E2E tests (Playwright): bun run test:e2e (starts servers automatically)
          - All tests: bun run test:all
          - Lint: bun run lint
          - Type check: bun run typecheck
          PROMPT_EOF

          PROMPT_APPEND=$(cat /tmp/prompt_append.txt)
          jq --arg append "$PROMPT_APPEND" '.agents.Sisyphus.prompt_append = $append' "$OMO_JSON" > /tmp/omo.json && mv /tmp/omo.json "$OMO_JSON"

          echo "$OPENCODE_AUTH_JSON" > ~/.local/share/opencode/auth.json
          chmod 600 ~/.local/share/opencode/auth.json

          echo "=== opencode.json ==="
          jq . ~/.config/opencode/opencode.json
          echo "=== oh-my-opencode.json ==="
          jq . ~/.config/opencode/oh-my-opencode.json

      - name: Collect Context
        id: context
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_ID_VAL: ${{ github.event.comment.id }}
          REPO: ${{ github.repository }}
        run: |
          if [[ "$EVENT_NAME" == "issue_comment" ]]; then
            ISSUE_NUM="$ISSUE_NUMBER"
            AUTHOR="$COMMENT_AUTHOR"
            COMMENT_ID="$COMMENT_ID_VAL"

            if gh api "repos/$REPO/issues/${ISSUE_NUM}" | jq -e '.pull_request' > /dev/null; then
              echo "type=pr" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            else
              echo "type=issue" >> $GITHUB_OUTPUT
              echo "number=${ISSUE_NUM}" >> $GITHUB_OUTPUT
            fi
          fi

          echo "comment<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "author=$AUTHOR" >> $GITHUB_OUTPUT
          echo "comment_id=$COMMENT_ID" >> $GITHUB_OUTPUT

      - name: Add eyes reaction
        if: steps.context.outputs.comment_id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
            -X POST -f content="eyes" || true

      - name: Add working label
        if: steps.context.outputs.number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          gh label create "sisyphus: working" \
            --repo "${{ github.repository }}" \
            --color "fcf2e1" \
            --description "Sisyphus is currently working on this" \
            --force || true
          
          if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
            gh pr edit "${{ steps.context.outputs.number }}" \
              --repo "${{ github.repository }}" \
              --add-label "sisyphus: working" || true
          else
            gh issue edit "${{ steps.context.outputs.number }}" \
              --repo "${{ github.repository }}" \
              --add-label "sisyphus: working" || true
          fi

      - name: Run oh-my-opencode
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          USER_COMMENT: ${{ steps.context.outputs.comment }}
          COMMENT_AUTHOR: ${{ steps.context.outputs.author }}
          CONTEXT_TYPE: ${{ steps.context.outputs.type }}
          CONTEXT_NUMBER: ${{ steps.context.outputs.number }}
          REPO_NAME: ${{ github.repository }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          CONVEX_AGENT_MODE: anonymous
          NEXT_PUBLIC_CONVEX_URL: http://127.0.0.1:3210
          NEXT_PUBLIC_CONVEX_SITE_URL: http://127.0.0.1:3211
          BETTER_AUTH_URL: http://localhost:3000
        run: |
          set -euo pipefail
          export PATH="$HOME/.opencode/bin:$PATH"

          cat > /tmp/prompt.txt <<PROMPT_EOF
          Your username is @sisyphus-agent, mentioned by @${COMMENT_AUTHOR} in ${REPO_NAME}.

          ## Context
          - Type: ${CONTEXT_TYPE}
          - Number: #${CONTEXT_NUMBER}
          - Repository: ${REPO_NAME}
          - Default Branch: ${DEFAULT_BRANCH}

          ## User's Request
          ${USER_COMMENT}

          ---

          Write everything using the todo tools.
          Then investigate and satisfy the request. Only if user requested to you to work explicitly, then use plan agent to plan, todo obsessively then create a PR to \`${DEFAULT_BRANCH}\` branch.
          When done, report the result to the issue/PR with \`gh issue comment ${CONTEXT_NUMBER}\` or \`gh pr comment ${CONTEXT_NUMBER}\`.
          PROMPT_EOF

          PROMPT=$(cat /tmp/prompt.txt)
          stdbuf -oL -eL bunx oh-my-opencode run "$PROMPT"

      - name: Push changes
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git add -A
            git commit -m "chore: changes by sisyphus-agent" || true
          fi

          BRANCH=$(git branch --show-current)
          if [[ "$BRANCH" != "main" && "$BRANCH" != "master" ]]; then
            git push origin "$BRANCH" || true
          fi

      - name: Update reaction and remove label
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          if [[ -n "${{ steps.context.outputs.comment_id }}" ]]; then
            REACTION_ID=$(gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              --jq '.[] | select(.content == "eyes") | .id' | head -1)
            if [[ -n "$REACTION_ID" ]]; then
              gh api -X DELETE "/repos/${{ github.repository }}/reactions/${REACTION_ID}" || true
            fi

            gh api "/repos/${{ github.repository }}/issues/comments/${{ steps.context.outputs.comment_id }}/reactions" \
              -X POST -f content="+1" || true
          fi

          if [[ -n "${{ steps.context.outputs.number }}" ]]; then
            if [[ "${{ steps.context.outputs.type }}" == "pr" ]]; then
              gh pr edit "${{ steps.context.outputs.number }}" \
                --repo "${{ github.repository }}" \
                --remove-label "sisyphus: working" || true
            else
              gh issue edit "${{ steps.context.outputs.number }}" \
                --repo "${{ github.repository }}" \
                --remove-label "sisyphus: working" || true
            fi
          fi
